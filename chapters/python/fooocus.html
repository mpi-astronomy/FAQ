

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Image Generation with Stable Diffusion and Fooocus &#8212; MPI-astronomy-FAQ</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/python/fooocus';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Introduction" href="../problems/straightline/README.html" />
    <link rel="prev" title="Why does my parallel code take much more time than a non-paralleled one?" href="parallel-code-slower.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="MPI-astronomy-FAQ - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="MPI-astronomy-FAQ - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    MPI-astronomy FAQ
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Publishing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../publishing/how-to-cite.html">How do I cite software in my papers?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publishing/how-to-publish-software.html">How do I publish my software?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publishing/how-to-color-plots.html">How to use color in scientific plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publishing/old-code.html">What to do with “legacy” code?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Python</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="virtualenv.html">Python Virtual environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="NumbaFun.html">Some Fun with Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel-code-slower.html">Why does my parallel code take much more time than a non-paralleled one?</a></li>


<li class="toctree-l1 current active"><a class="current reference internal" href="#">Image Generation with Stable Diffusion and Fooocus</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Straightline fitting problem</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../problems/straightline/README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../problems/straightline/straighlinefit_emcee.html">Emcee based solution</a></li>


<li class="toctree-l1"><a class="reference internal" href="../problems/straightline/straighlinefit_jax.html">Numpyro+jax based solution</a></li>


<li class="toctree-l1"><a class="reference internal" href="../problems/straightline/straighlinefit_pymc3.html">PyMC3 based solution</a></li>


<li class="toctree-l1"><a class="reference internal" href="../problems/straightline/straighlinefit_pystan.html">Pystan based solution</a></li>



</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mpi-astronomy/FAQ" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mpi-astronomy/FAQ/issues/new?title=Issue%20on%20page%20%2Fchapters/python/fooocus.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/python/fooocus.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Image Generation with Stable Diffusion and Fooocus</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-fooocus">Installing Fooocus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-fooocus">Starting Fooocus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-images">Generating Images</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-advanced-tab">The Advanced Tab</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-images">Input Images</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-adding-a-new-model">Extra: Adding a new Model</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="image-generation-with-stable-diffusion-and-fooocus">
<h1>Image Generation with Stable Diffusion and Fooocus<a class="headerlink" href="#image-generation-with-stable-diffusion-and-fooocus" title="Permalink to this heading">#</a></h1>
<p>Image generation tools are now available to anyone using open source tools and consumer grade hardware. In this note I will detail how to install <a class="reference external" href="https://github.com/lllyasviel/Fooocus">Fooocus</a>, an frontend built on <a class="reference external" href="https://www.gradio.app/">Gradio</a> that can take advantage of Stability AI’s Stable Diffusion (<a class="reference external" href="https://stability.ai/stable-diffusion">SD</a>) model checkpoints. These checkpoints have already been trained (and in some cases, fine-tuned) making them ideal for quick image generation for a wide array of use cases.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to generate images on reasonable time scales (e.g. less than a minute) it is necessary to have a decently powerful stand-alone GPU.</p>
</div>
<section id="installing-fooocus">
<h2>Installing Fooocus<a class="headerlink" href="#installing-fooocus" title="Permalink to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/lllyasviel/Fooocus">Fooocus</a> installation procedures are relatively straightforward for Linux, Windows, and macOS, including systems with either AMD or NVIDIA GPUs. In this guide I will focus on the installation of Fooocus on the MPIA Astro GPU Nodes which are equipped with enterprise GPUs that will be more than up to the task of processing our images. However, due to the software available on the nodes, the installation procedure requires a slight deviation from what’s provided directly from Fooocus.</p>
<p>Let’s begin by logging into the node of our choice. In this example we will log in to astro-gpu-node1. Let’s open an SSH connection and print out the GPU information (for NVIDIA GPUs).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>user@astro-gpu-node1
nvidia-smi
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">NVIDIA</span><span class="o">-</span><span class="n">SMI</span> <span class="mf">515.43.04</span>    <span class="n">Driver</span> <span class="n">Version</span><span class="p">:</span> <span class="mf">515.43.04</span>    <span class="n">CUDA</span> <span class="n">Version</span><span class="p">:</span> <span class="mf">11.7</span>     <span class="o">|</span>
<span class="o">|-------------------------------+----------------------+----------------------+</span>
<span class="o">|</span> <span class="n">GPU</span>  <span class="n">Name</span>        <span class="n">Persistence</span><span class="o">-</span><span class="n">M</span><span class="o">|</span> <span class="n">Bus</span><span class="o">-</span><span class="n">Id</span>        <span class="n">Disp</span><span class="o">.</span><span class="n">A</span> <span class="o">|</span> <span class="n">Volatile</span> <span class="n">Uncorr</span><span class="o">.</span> <span class="n">ECC</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Fan</span>  <span class="n">Temp</span>  <span class="n">Perf</span>  <span class="n">Pwr</span><span class="p">:</span><span class="n">Usage</span><span class="o">/</span><span class="n">Cap</span><span class="o">|</span>         <span class="n">Memory</span><span class="o">-</span><span class="n">Usage</span> <span class="o">|</span> <span class="n">GPU</span><span class="o">-</span><span class="n">Util</span>  <span class="n">Compute</span> <span class="n">M</span><span class="o">.</span> <span class="o">|</span>
<span class="o">|</span>                               <span class="o">|</span>                      <span class="o">|</span>               <span class="n">MIG</span> <span class="n">M</span><span class="o">.</span> <span class="o">|</span>
<span class="o">|===============================+======================+======================|</span>
<span class="o">|</span>   <span class="mi">0</span>  <span class="n">Quadro</span> <span class="n">RTX</span> <span class="mi">6000</span>     <span class="n">On</span>   <span class="o">|</span> <span class="mi">00000000</span><span class="p">:</span><span class="mi">3</span><span class="n">B</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Off</span> <span class="o">|</span>                    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>   <span class="mi">30</span><span class="n">C</span>    <span class="n">P0</span>    <span class="mi">55</span><span class="n">W</span> <span class="o">/</span> <span class="mi">250</span><span class="n">W</span> <span class="o">|</span>   <span class="mi">2863</span><span class="n">MiB</span> <span class="o">/</span> <span class="mi">23040</span><span class="n">MiB</span> <span class="o">|</span>      <span class="mi">0</span><span class="o">%</span>      <span class="n">Default</span> <span class="o">|</span>
<span class="o">|</span>                               <span class="o">|</span>                      <span class="o">|</span>                  <span class="n">N</span><span class="o">/</span><span class="n">A</span> <span class="o">|</span>
<span class="o">+-------------------------------+----------------------+----------------------+</span>
<span class="o">|</span>   <span class="mi">1</span>  <span class="n">Quadro</span> <span class="n">RTX</span> <span class="mi">6000</span>     <span class="n">On</span>   <span class="o">|</span> <span class="mi">00000000</span><span class="p">:</span><span class="n">D8</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Off</span> <span class="o">|</span>                    <span class="mi">0</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>   <span class="mi">33</span><span class="n">C</span>    <span class="n">P0</span>    <span class="mi">55</span><span class="n">W</span> <span class="o">/</span> <span class="mi">250</span><span class="n">W</span> <span class="o">|</span>   <span class="mi">2053</span><span class="n">MiB</span> <span class="o">/</span> <span class="mi">23040</span><span class="n">MiB</span> <span class="o">|</span>      <span class="mi">0</span><span class="o">%</span>      <span class="n">Default</span> <span class="o">|</span>
<span class="o">|</span>                               <span class="o">|</span>                      <span class="o">|</span>                  <span class="n">N</span><span class="o">/</span><span class="n">A</span> <span class="o">|</span>
<span class="o">+-------------------------------+----------------------+----------------------+</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We need to note the CUDA version listed here for following installation steps.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This view also allows us to see what the GPU usage is. Of course, the less utilization, the faster our model will run. This is makes <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code> a quick and easy way to check the current GPU utilization on the <code class="docutils literal notranslate"><span class="pre">astro-gpu-node</span></code> servers.</p>
</div>
<p>We are going to follow the default Fooocus installation instructions with a slight modification to account for the outdated CUDA version available on the GPU nodes. We’ll be loading the native Anaconda module on the astro-nodes to install the software.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>purge<span class="w"> </span><span class="c1"># Optional, gets rid of any previously loaded modules</span>
module<span class="w"> </span>load<span class="w"> </span>anaconda3-py3.10
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/lllyasviel/Fooocus.git
<span class="nb">cd</span><span class="w"> </span>Fooocus
conda<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>environment.yaml
conda<span class="w"> </span>activate<span class="w"> </span>fooocus
</pre></div>
</div>
<p>We can now follow the instructions for <a class="reference external" href="https://pytorch.org/get-started/previous-versions/">installing older versions of PyTorch</a> (our acceleration framework) to be compatible with our version of CUDA. Here I am following the instructions for CUDA 11.7 as this is the version available on the astro-gpu-node at the time of writing.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span><span class="nv">pytorch</span><span class="o">==</span><span class="m">2</span>.0.1<span class="w"> </span><span class="nv">torchvision</span><span class="o">==</span><span class="m">0</span>.15.2<span class="w"> </span><span class="nv">torchaudio</span><span class="o">==</span><span class="m">2</span>.0.2<span class="w"> </span>pytorch-cuda<span class="o">=</span><span class="m">11</span>.7<span class="w"> </span>-c<span class="w"> </span>pytorch<span class="w"> </span>-c<span class="w"> </span>nvidia
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements_versions.txt
</pre></div>
</div>
<p>And there we are! That should be it for installation.</p>
</section>
<section id="starting-fooocus">
<h2>Starting Fooocus<a class="headerlink" href="#starting-fooocus" title="Permalink to this heading">#</a></h2>
<p>Let’s begin by activating the environment and running the main script. The first thing that will happen is a Stable Diffusion XL model checkpoint will have to be downloaded. These can several gigabytes in size so may take some time.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>fooocus
python<span class="w"> </span>entry_with_update.py
</pre></div>
</div>
<p>While the code is initalizing, a web browser might pop up on your local machine over an X-server. Feel free to close it, as we’re going to be using our local web-browser than than the <a class="reference external" href="https://apps.kde.org/konqueror/">KDE default</a> which will allow us to properly load the app. We’ll know the model is ready to run once we’ve seen the output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>App started successful. Use the app with http://127.0.0.1:XXXX/ or 127.0.0.1:XXXX
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We will need to remember the port that the server is running on (i.e. the numbers in the <code class="docutils literal notranslate"><span class="pre">XXXX</span></code> spot above).</p>
</div>
<p>The Fooocus/Gradio interface is a web app built on <a class="reference external" href="https://svelte.dev/">Svelt</a>. Therefore, in order to interact with the code, we’re going to need to forward the traffic to our local machine. We can select any port on our local machine, which we’ll label as <code class="docutils literal notranslate"><span class="pre">YYYY</span></code>. In a new terminal we can run the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-L<span class="w"> </span>YYYY:127.0.0.1:XXXX<span class="w"> </span>user@astro-gpu-node1
</pre></div>
</div>
<p>In general, I just set use whatever port is used by the remote server. As the default port for Fooocus is <code class="docutils literal notranslate"><span class="pre">7865</span></code> I forward this <code class="docutils literal notranslate"><span class="pre">7865</span></code> on our local machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">7865</span>:127.0.0.1:7865<span class="w"> </span>user@astro-gpu-node1
</pre></div>
</div>
<p>By leaving these two terminals open, one to run the server, and one to forward the web traffic, we can now open Fooocus on our local machine and start generating images.</p>
</section>
<section id="generating-images">
<h2>Generating Images<a class="headerlink" href="#generating-images" title="Permalink to this heading">#</a></h2>
<p>We can now open our web browser of choice, for me it’s <a class="reference external" href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a>, and navigate to the Fooocus web application by navigating to <code class="docutils literal notranslate"><span class="pre">http://localhost:YYYY/</span></code>, or in my case <code class="docutils literal notranslate"><span class="pre">http://localhost:7865/</span></code>. If an empty image appears with a text box beneath it, then the Fooocus application has launched correctly!</p>
<p>Generating an image is now as simple as typing any prompt and hitting generate! We can watch the output logs in our original terminal session. The default settings will produce two images from our prompt.
If the GPUs are not being used by other users, we should expect about 30-45s per image.
While the Fooocus documentation provides a description of the different options, I intend to provide a short introduction to the most important configurations we can tweak in the UI.
If you are familiar with Midjourney, one of the more popular image generation services, I recommend reading the Fooocus documentation section on transitioning between the two.</p>
<section id="the-advanced-tab">
<h3>The Advanced Tab<a class="headerlink" href="#the-advanced-tab" title="Permalink to this heading">#</a></h3>
<p>By clicking the advanced checkbox at the bottom of the page, we can open the a panel whioch provides us with the fine grained control of our image generation process and consists of the following sections, each of which provides increasingly detailed control:</p>
<ul class="simple">
<li><p>Setting:</p>
<ul>
<li><p>Performance: Enables balancing of speed versus quality of output image.</p></li>
<li><p>Aspect Ratios: Controls the output resolution of images (output images may still be upscaled using Fooocus).</p></li>
<li><p>Image Number: Number of images generated.</p></li>
<li><p>Negative Prompt: In contrast to the image prompt, the negative prompt enables us to describe what we do not want to see in our image.</p></li>
<li><p>Random: By de-selecting random we can force our RNG seed.</p></li>
</ul>
</li>
<li><p>Style: These are predefine prompt modifiers that have been tested with SDXL. In essence, these act on your prompts (and negative prompts) to modify your language in order to try to produce an output of a certain aesthetic quality. Checking a few of these can affect the look of your final image. Fooocus will select a few defaults, but play around by combining some of your favorite modifiers.</p></li>
<li><p>Model: Here we can incorporate different SDXL model checkpoints which can be combined along with smaller “LoRA” models (and their corresponding weights). The default model should be enough for most cases, but see the section at the end of this guide if you are interested in adding additional models.</p></li>
<li><p>Advanced:</p>
<ul>
<li><p>Guidance Scale: Details how strictly should the input image adhere to your prompt. Lower values give us more “creative” but more unexpected results.</p></li>
<li><p>Sharpness: Details if textures should be fuzzier or sharper in the resultant image.</p></li>
</ul>
</li>
</ul>
</section>
<section id="input-images">
<h3>Input Images<a class="headerlink" href="#input-images" title="Permalink to this heading">#</a></h3>
<p>One of the most powerful features of Stable Diffusion is not just generation from prompts, but from input images. By clicking the Input Image selection box, we can now edit original images (or AI generated images) in a few specificy ways:</p>
<ul class="simple">
<li><p>Upscale or Variation: Here we can either upscale (e.g. improve the resolution of) or vary (e.g. modify with prompt) our input image. Selecting disabled will ignore the input image. Similarly, selected upscale will ignore the input text prompt.</p></li>
<li><p>Image Prompt: Using images as prompts, we can combine input images, or even place objects in the images in our scenes. This is fun to play around with, especially with the advanced settings turned on. For some more practical examples and discussion, see this <a class="reference external" href="https://github.com/lllyasviel/Fooocus/discussions/557">Fooocus announcement</a>.</p></li>
<li><p>Input or Outpaint: These are powerful methods describing how to use AI to add and remove modify inside (inpaint) or generate content outside (outpaint) your image boundaries. In the top right of the image the brush size of the cursor can be modified, along with an undo tool and a tool to erase the current highlighted portion.</p>
<ul>
<li><p>Inpaint or Outpaint: Selected the four directions will control which directions are “outpainted” in the resultant image. In addition, you can use your cursor to highlight portions in the image will be “inpainted”. Both rely on the input text prompt.</p></li>
<li><p>Improve Detail (face, hand, eyes, etc.): Let’s face it, AI generated images sometimes have some glaring issues, especially with hands and facial features. These can be addressed by highlighting these areas using the cursor and describing what should be improved.</p></li>
<li><p>Modify Content (add objects, change background, etc.): Here we can do some more specific kinds of inpainting to add features to our image. I haven’t played around with it enough to exactly know how it varies or what it is better suited for.</p></li>
</ul>
</li>
</ul>
<p>With all of these controls under your belt, you should be well on your way to producing your AI generated images with Stable Diffusion XL and Fooocus!</p>
</section>
</section>
<section id="extra-adding-a-new-model">
<h2>Extra: Adding a new Model<a class="headerlink" href="#extra-adding-a-new-model" title="Permalink to this heading">#</a></h2>
<p>One of the most exciting parts of image generation from Stable Diffusion XL checkpoints is the ability to start from <em>any</em> SDXL checkpoint, not just the defaults provided here.
In fact, Fooocus ships with two additional default models, one designed for photorealism and the other for anime-style images.
If you run <code class="docutils literal notranslate"><span class="pre">entry_with_update.py</span></code> with the <code class="docutils literal notranslate"><span class="pre">--preset</span></code> flag set as <code class="docutils literal notranslate"><span class="pre">realistic</span></code> or <code class="docutils literal notranslate"><span class="pre">anime</span></code>, <em>both</em> additional models will be downloaded.
Either of the three default models can then be selected in the Advanced settings tab.</p>
<p>Additional models can be downloaded from the internet.
Fooocus currently supports the following types of models:</p>
<ul class="simple">
<li><p>The base model must always be an SDXL model.</p></li>
<li><p>The output of the SDXL model can be used as input to a secondary model, also known as the refiner. The refiner can either be an SDXL or an SD1.5 model (At least according to the documentation, Foocus may support other refiners between 1.5 and XL, but I haven’t done extensive testing.).</p></li>
<li><p>Low-Rank Adaptations or <a class="reference external" href="https://aituts.com/stable-diffusion-lora/">LoRAs</a> are additional smaller models than can be combined with the base model to add additional concepts to the model. Fooocus can support up to four additional LoRAs which can broadly be separated into two categories:</p>
<ul>
<li><p>Subjects which are characters, expressions, or even objects to be incorporated in the scene.</p></li>
<li><p>Styles can include aesthetics, and, for want of a better word, styles, to be incorporated into the output.</p></li>
</ul>
</li>
</ul>
<p>Checkpoints (e.g. SDXL or SD1.5 models) should be placed in the <code class="docutils literal notranslate"><span class="pre">Fooocus/models/checkpoints</span></code> directory, while LoRAs should be placed in the <code class="docutils literal notranslate"><span class="pre">Fooocus/models/loras</span></code> directory and will then appear as options upon restarting the code. There are quite a few other directory to place additional configurations and tweaks, but at this point you’re equipped to set off on this adventure on your own!</p>
<p>Good luck!</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/python"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="parallel-code-slower.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Why does my parallel code take much more time than a non-paralleled one?</p>
      </div>
    </a>
    <a class="right-next"
       href="../problems/straightline/README.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Introduction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-fooocus">Installing Fooocus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-fooocus">Starting Fooocus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-images">Generating Images</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-advanced-tab">The Advanced Tab</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-images">Input Images</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-adding-a-new-model">Extra: Adding a new Model</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Iva Momcheva, Morgan Fouesneau, and Raphael E. Hviding
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>